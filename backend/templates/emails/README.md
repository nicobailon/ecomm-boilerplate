# Email Templates Security Guidelines

## EJS Template Security

All email templates must follow these security guidelines to prevent XSS attacks:

### 1. Always Use Escaped Output

- **Use `<%= %>` for user-provided data** - This escapes HTML entities
- **Never use `<%- %>` for user data** - This outputs raw HTML without escaping
- **Only use `<%- %>` for pre-rendered HTML** from trusted sources (like the body content in base.ejs)

### Examples

✅ **Correct - Escaped output:**
```ejs
<h1>Welcome, <%= userName %>!</h1>
<p>Your email: <%= userEmail %></p>
<a href="<%= productUrl %>">View Product</a>
```

❌ **Incorrect - Unescaped output:**
```ejs
<h1>Welcome, <%- userName %>!</h1>  <!-- XSS vulnerability! -->
<p>Your email: <%- userEmail %></p>  <!-- XSS vulnerability! -->
```

### 2. URL Sanitization

URLs in email templates are sanitized by the EmailService before rendering:
- `javascript:`, `data:`, `vbscript:`, and other dangerous protocols are blocked
- Only `http://`, `https://`, and relative URLs are allowed
- Invalid URLs are replaced with `#`

### 3. Template Guidelines

1. **User Input**: Always escape with `<%= %>`
   - Names, emails, addresses
   - Product names, descriptions
   - Any data from database

2. **URLs**: Always escape with `<%= %>`
   - All href attributes
   - Image src attributes
   - Any URL in the template

3. **Pre-rendered HTML**: Only use `<%- %>` for:
   - The `body` variable in base.ejs
   - HTML generated by our own code

4. **Numbers and Dates**: Safe to use either, but prefer `<%= %>` for consistency

### 4. Testing for XSS

When adding new templates or modifying existing ones:

1. Test with malicious input:
   ```javascript
   const testData = {
     userName: '<script>alert("XSS")</script>',
     productName: '<img src=x onerror=alert("XSS")>',
     url: 'javascript:alert("XSS")'
   };
   ```

2. Verify the rendered output escapes all HTML entities

3. Run the XSS prevention tests:
   ```bash
   npm test backend/services/__tests__/email-xss.test.ts
   ```

### 5. Manual Review Checklist

Before committing changes to email templates:

- [ ] All user data uses `<%= %>` for escaping
- [ ] No `<%- %>` is used with user-provided data
- [ ] All URLs use `<%= %>` for escaping
- [ ] Test with malicious input data
- [ ] Run XSS prevention tests

### 6. ESLint Configuration

While ESLint doesn't directly lint EJS files, the project is configured to:
- Enforce `@typescript-eslint/no-explicit-any` to prevent type safety issues
- Prevent `as any` type assertions via `@typescript-eslint/consistent-type-assertions`
- These rules ensure the EmailService maintains type safety when working with templates

## Adding New Templates

1. Create the template in `/backend/templates/emails/`
2. Use `<%= %>` for all dynamic content
3. Add the template to the `EmailTemplate` enum in `/backend/types/email.types.ts`
4. Create a corresponding data interface
5. Add a method in `EmailService` to send the email
6. Write tests including XSS prevention tests